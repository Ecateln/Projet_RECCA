<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" media="screen" type="text/css" href="/public/css/test3Style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="new_chat_button">
                <!-- Bouton de rétraction ajouté ici -->
                <button class="retract-button" onclick="toggleSidebar()" title="Rétracter/Étendre la sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
                        <path d="M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm240-80h400v-480H400v480Zm-80 0v-480H160v480h160Zm-160 0v-480 480Zm160 0h80-80Zm0-480h80-80Z"/>
                    </svg>
                </button>
                
                <div class="sidebar-content">
                    <label class="internet" for="internetToggle">
                        <span class="switch-label">
                            <span class="toggle-wrapper">
                                <input type="checkbox" id="internetToggle" />
                                <span class="slider"></span>
                                <span class="label-text">Internet ?</span>
                            </span>
                        </span>
                    </label>
                    <a href="#" class="new_chat">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M120-160v-600q0-33 23.5-56.5T200-840h480q33 0 56.5 23.5T760-760v203q-10-2-20-2.5t-20-.5q-10 0-20 .5t-20 2.5v-203H200v400h283q-2 10-2.5 20t-.5 20q0 10 .5 20t2.5 20H240L120-160Zm160-440h320v-80H280v80Zm0 160h200v-80H280v80Zm400 280v-120H560v-80h120v-120h80v120h120v80H760v120h-80ZM200-360v-400 400Z"/></svg>Nouveau chat
                    </a>
                </div>
            </div>
            
            <div class="sidebar-content">
                <hr>
                <div class="section">
                    <h3>Conversations</h3>
                    <div id="conversation-list" class="conversation-list">
                        <button>Conversation 1</button>
                        <button>Conversation 2</button>
                        <button>Conversation 3</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-area">
            <div class="section">
                <header class="header">
                    <h1>Recca</h1>
                </header>
                <div class="chat">
                    <div class="message prompt">
                        <p>prompt boubouboubouboubouboubouboubou...</p>
                    </div>
                    <div class="message response">
                        <p>réponse fournie par Reccabouboubouboubouboubouboubou...</p>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Type your message..." >
                <button id="send-btn" onclick="addMessage()" >Send</button>
            </div>
        </div>
    </div>

    <script src="/static/js/socket-io.js"></script>
    <script>
        let socket = null;
        let currentConversation = null;
        let isAuthenticated = false;
        let currentResponse = '';
        let sidebarRetracted = false;
        
        // Fonction pour basculer l'état de la sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarRetracted = !sidebarRetracted;
            
            if (sidebarRetracted) {
                sidebar.classList.add('retracted');
            } else {
                sidebar.classList.remove('retracted');
            }
            
            // Sauvegarder l'état dans le localStorage si disponible
            try {
                localStorage.setItem('sidebarRetracted', sidebarRetracted.toString());
            } catch (e) {
                // Ignore si localStorage n'est pas disponible
            }
        }
        
        // Restaurer l'état de la sidebar au chargement
        function restoreSidebarState() {
            try {
                const saved = localStorage.getItem('sidebarRetracted');
                if (saved === 'true') {
                    sidebarRetracted = true;
                    document.getElementById('sidebar').classList.add('retracted');
                }
            } catch (e) {
                // Ignore si localStorage n'est pas disponible
            }
        }
        
        // Initialize socket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', () => {
                log('Connected to server', 'received');
                updateStatus('connected', 'Connected');
            });
            
            socket.on('disconnect', () => {
                log('Disconnected from server', 'error');
                updateStatus('disconnected', 'Disconnected');
                isAuthenticated = false;
                updateUI();
            });
            
            socket.on('login_success', (conversations) => {
                log('Login successful', 'received');
                updateStatus('authenticated', 'Authenticated');
                isAuthenticated = true;
                displayConversations(conversations);
                updateUI();
            });
            
            socket.on('conversation', (conversation) => {
                log('Received conversation: ' + conversation.title, 'received');
                currentConversation = conversation;
                displayMessages(conversation.messages);
                updateUI();
            });
            
            socket.on('res', (token) => {
                if (token === null) {
                    // End of response
                    log('Response complete', 'received');
                    if (currentResponse.trim()) {
                        addMessage('assistant', currentResponse);
                        currentResponse = '';
                    }
                    updateUI();
                } else {
                    // Streaming token
                    currentResponse += token;
                    updateStreamingMessage();
                }
            });
            
            socket.on('error', (message) => {
                log('Error: ' + message, 'error');
                addMessage('error', 'Error: ' + message);
            });
        }
        
        function updateStatus(type, text) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.className = 'status ' + type;
                statusEl.textContent = text;
            }
        }
        
        function updateUI() {
            const loginBtn = document.getElementById('login-btn');
            const tokenInput = document.getElementById('token-input');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (loginBtn) loginBtn.disabled = isAuthenticated;
            if (tokenInput) tokenInput.disabled = isAuthenticated;
            if (messageInput) messageInput.disabled = !currentConversation;
            if (sendBtn) sendBtn.disabled = !currentConversation;
        }
        
        function log(message, type = 'info') {
            const logsEl = document.getElementById('logs');
            if (logsEl) {
                const entry = document.createElement('div');
                entry.className = 'log-entry ' + type;
                entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
                logsEl.appendChild(entry);
                logsEl.scrollTop = logsEl.scrollHeight;
            }
        }
        
        function login() {
            const token = document.getElementById('token-input').value;
            if (!token.trim()) {
                alert('Please enter a token');
                return;
            }
            
            log('Sending login with token: ' + token, 'sent');
            socket.emit('login', token);
        }
        
        function displayConversations(conversations) {
            const listEl = document.getElementById('conversation-list');
            listEl.innerHTML = '';
            
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.textContent = conv.title;
                item.onclick = () => selectConversation(conv.id, item);
                listEl.appendChild(item);
            });
        }
        
        function selectConversation(id, element) {
            // Remove previous selection
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select new conversation
            element.classList.add('selected');
            
            log('Requesting conversation: ' + id, 'sent');
            socket.emit('request_conversation', id);
        }
        
        function displayMessages(messages) {
            const messagesEl = document.getElementById('messages');
            if (messagesEl) {
                messagesEl.innerHTML = '';
                
                messages.forEach(msg => {
                    addMessage(msg.role, msg.content, new Date(msg.date));
                });
            }
        }
        
        function addMessage(role, content, date = new Date()) {
            const messagesEl = document.getElementById('messages');
            if (messagesEl) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message ' + role;
                
                const timestamp = date.toLocaleTimeString();
                messageEl.innerHTML = `<strong>${role}:</strong> ${content}<br><small>${timestamp}</small>`;
                
                messagesEl.appendChild(messageEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        }
        
        function updateStreamingMessage() {
            const messagesEl = document.getElementById('messages');
            if (messagesEl) {
                let streamingEl = messagesEl.querySelector('.streaming-message');
                
                if (!streamingEl) {
                    streamingEl = document.createElement('div');
                    streamingEl.className = 'message assistant streaming-message';
                    messagesEl.appendChild(streamingEl);
                }
                
                const timestamp = new Date().toLocaleTimeString();
                streamingEl.innerHTML = `<strong>assistant:</strong> ${currentResponse}<span style="animation: blink 1s infinite;">|</span><br><small>${timestamp}</small>`;
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            log('Sending query: ' + message, 'sent');
            socket.emit('query', message);
            
            addMessage('user', message);
            input.value = '';
            currentResponse = '';
            
            // Disable send button during response
            document.getElementById('send-btn').disabled = true;
        }
        
        // Handle Enter key in message input
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Handle Enter key in token input
        const tokenInput = document.getElementById('token-input');
        if (tokenInput) {
            tokenInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        }
        
        // Add CSS for blinking cursor
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            restoreSidebarState();
            initSocket();
            updateUI();
        });
    </script>
</body>
</html>